# 충돌 해결 - 기존 자산과의 처리

## 1. 프로젝트 내 기존 자산 감지

### 감지 대상

```bash
# 토큰 관련 파일
tailwind.config.*                    # Tailwind 설정
**/tokens.css, **/tokens.scss        # CSS/SCSS 토큰
**/design-tokens.*                   # 디자인 토큰 파일
**/variables.css, **/variables.scss  # CSS 변수
**/theme.ts, **/theme.js             # 테마 설정

# 컴포넌트 디렉토리
components/                          # 컴포넌트
ui/                                  # UI 요소
src/components/
src/ui/

# 기존 규칙
.claude/rules/design-system/
```

### 감지 로직

```bash
# 1. 토큰 파일 검색
find . -maxdepth 4 -name "tailwind.config.*" -o -name "*tokens*" -o -name "*variables*" 2>/dev/null

# 2. 컴포넌트 디렉토리 검색
find . -maxdepth 3 -type d \( -name "components" -o -name "ui" \) 2>/dev/null

# 3. 기존 규칙 확인
ls .claude/rules/design-system/ 2>/dev/null
```

---

## 2. 기존 자산 발견 시 질문

### 토큰 파일이 있는 경우

```
📁 프로젝트에 기존 토큰 정의가 발견되었습니다.

발견된 파일:
- tailwind.config.ts (Tailwind 테마 설정)
- src/styles/tokens.css (CSS 변수 정의)

Figma 토큰과 어떻게 처리할까요?

1. **비교 분석** - 기존 토큰과 Figma 토큰 차이점 표시
2. **Figma 우선** - Figma 토큰 기준으로 규칙 생성 (기존 파일과 불일치 경고)
3. **기존 우선** - 기존 토큰 유지, Figma에만 있는 토큰 추가 제안
4. **취소** - 수동 검토 후 재시도
```

### 컴포넌트 디렉토리가 있는 경우

```
📁 프로젝트에 기존 컴포넌트가 발견되었습니다.

발견된 컴포넌트:
- src/components/ (23개 파일)
  - Button.tsx, Card.tsx, Input.tsx ...
- src/ui/ (12개 파일)
  - Badge.tsx, Avatar.tsx ...

Figma 컴포넌트와 어떻게 처리할까요?

1. **매핑 분석** - 기존 컴포넌트와 Figma 컴포넌트 매칭
2. **Figma 기준** - Figma 컴포넌트 목록으로 규칙 생성
3. **기존 기준** - 기존 컴포넌트 유지, Figma에서 누락된 것 제안
4. **취소** - 수동 검토 후 재시도
```

---

## 3. 충돌 감지 (기존 규칙)

### 확인 대상

```bash
.claude/rules/design-system/
├── AGENTS.md
├── RULE.md
└── references/
```

---

## 충돌 시 사용자 질문

기존 규칙 파일이 발견되면 **반드시** 다음을 질문:

```
📁 기존 디자인 시스템 규칙이 발견되었습니다.

경로: .claude/rules/design-system/
파일: AGENTS.md, RULE.md, references/*

처리 방법을 선택해주세요:

1. **덮어쓰기**
   - 기존 규칙을 완전히 새 규칙으로 교체
   - 기존 커스터마이징 내용 손실

2. **병합**
   - 기존 규칙에 새 정보 추가
   - 수동 검토 필요 (충돌 부분 표시)

3. **백업 후 덮어쓰기**
   - 기존 파일을 .backup/에 저장 후 덮어쓰기
   - 나중에 복원 가능

4. **취소**
   - 작업 중단

어떻게 처리할까요? (1/2/3/4)
```

---

## 처리 방법별 동작

### 1. 덮어쓰기

```bash
# 기존 파일 삭제
rm -rf .claude/rules/design-system/

# 새 파일 생성
mkdir -p .claude/rules/design-system/references/
# ... 파일 작성
```

### 2. 병합

```markdown
## 병합 프로세스

1. 기존 파일 읽기
2. 새 내용과 비교
3. 충돌 부분 표시

### 충돌 표시 형식

<<<<<<< EXISTING
기존 내용
=======
새 내용 (Figma에서 추출)
>>>>>>> NEW

4. 사용자에게 수동 검토 요청
```

**병합 우선순위:**
- 새로운 토큰: 추가
- 기존 토큰과 값이 다름: 충돌 표시
- 기존에만 있는 토큰: 유지 (삭제 안 함)

### 3. 백업 후 덮어쓰기

```bash
# 백업 디렉토리 생성
mkdir -p .claude/rules/.backup/design-system-{timestamp}/

# 기존 파일 이동
mv .claude/rules/design-system/* .claude/rules/.backup/design-system-{timestamp}/

# 새 파일 생성
# ...
```

**백업 경로 예시:**
```
.claude/rules/.backup/
└── design-system-2024-01-15-143022/
    ├── AGENTS.md
    ├── RULE.md
    └── references/
```

### 4. 취소

```
작업이 취소되었습니다.
기존 규칙 파일은 변경되지 않았습니다.
```

---

## 특수 충돌 케이스

### 다른 Figma 파일에서 추출된 경우

```
⚠️ 기존 규칙은 다른 Figma 파일에서 추출되었습니다.

기존: figma.com/file/ABC123 (2024-01-10 추출)
새로: figma.com/file/XYZ789

동일한 디자인 시스템인가요?
- Yes: 업데이트로 처리 (덮어쓰기/병합)
- No: 별도 규칙으로 생성 (.claude/rules/design-system-v2/)
```

### 수동 수정된 규칙

```
⚠️ 기존 규칙에 수동 수정 흔적이 있습니다.

변경된 파일:
- RULE.md (커스텀 규칙 추가됨)
- references/tokens.md (토큰 수정됨)

수동 수정 내용을 유지할까요?
- 유지: 병합 모드로 진행
- 무시: 덮어쓰기로 진행
```

---

## 충돌 방지 권장사항

### 1. 원소스 명시

생성되는 규칙 파일에 원소스 정보 포함:

```markdown
<!--
  Generated by: figma-design-rule-extractor
  Source: https://www.figma.com/file/ABC123
  Date: 2024-01-15T14:30:22Z
  DO NOT EDIT MANUALLY - 수동 수정 시 재생성 때 손실될 수 있음
-->
```

### 2. 커스텀 규칙 분리

수동 추가 규칙은 별도 파일로:

```
.claude/rules/design-system/
├── RULE.md              # 자동 생성 (Figma)
└── references/
    ├── tokens.md        # 자동 생성 (Figma)
    └── custom.md        # 수동 추가 (보존됨)
```

### 3. 버전 관리 활용

```bash
# 변경 전 커밋
git add .claude/rules/design-system/
git commit -m "chore: backup design system rules before regeneration"

# 재생성 후 diff 확인
git diff .claude/rules/design-system/
```
